<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="The Money Game">
    <meta name="theme-color" content="#7BA8A8">
    
    <link rel="apple-touch-icon" href="./icon.png">
    <link rel="icon" type="image/png" href="./icon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="./manifest.json">

    <title>The Money Game üêª</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; -webkit-user-select: none; user-select: none; }
        html, body { width: 100%; height: 100%; overflow: hidden; }

        :root {
            --primary: #7BA8A8; --primary-light: #D4E8E8; --primary-dark: #5A8080;
            --success: #9BC997; --warning: #F5D5A8; --danger: #F5B8B8;
            --bg: #FBF6F0; --surface: #FFFFFF; --text: #3D3D3D;
            --text-light: #8B8B7A; --border-color: #C9A88A; --crisis: #E74C3C;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg);
            background-image: url('./fondo.png');
            background-size: cover; background-position: center; background-attachment: fixed;
            color: var(--text);
            display: flex; flex-direction: column; height: 100vh;
            padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right);
        }

        .container { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 12px; padding-bottom: 120px; }

        /* HEADER */
        header {
            background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('./banner.png');
            background-size: cover; background-position: center;
            border-radius: 24px; padding: 40px 20px; margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0, 0.15); border: 2px solid rgba(255,255,255,0.6);
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        .header-text h1 { font-family: 'Fredoka One', cursive; font-size: 2.2em; color: #FFFFFF; line-height: 1; margin-bottom: 5px; text-shadow: 0px 2px 4px rgba(0,0,0,0.6); }
        .header-text p { font-size: 0.9em; color: rgba(255, 255, 255, 0.9); font-weight: 600; text-shadow: 0px 1px 2px rgba(0,0,0,0.6); }

        /* MEN√ö DE CASILLAS (GRID) */
        .tabs { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr);
            gap: 8px; 
            margin-bottom: 20px; 
        }
        
        .tab-btn { 
            padding: 8px; border: none; background: rgba(255, 255, 255, 0.9); cursor: pointer; color: var(--text); 
            border-radius: 12px; transition: all 0.1s; font-family: 'Poppins'; font-weight: 600; font-size: 0.75em; 
            border: 1px solid transparent; box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 70px; gap: 5px;
        }
        .tab-btn i { font-size: 1.4em; margin-bottom: 2px; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(123, 168, 168, 0.4); transform: translateY(-2px); font-weight: 700; }

        .tab-content { display: none; animation: fadeIn 0.2s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* UI */
        .month-selector { background: rgba(255, 255, 255, 0.95); padding: 10px 14px; border-radius: 12px; margin-bottom: 15px; display: flex; gap: 12px; align-items: center; border: 2px solid var(--border-color); backdrop-filter: blur(5px); }
        .month-selector label { font-weight: 700; color: var(--primary); font-size: 1.2em; }
        .month-selector input { flex: 1; border: none; background: transparent; padding: 8px; font-family: 'Poppins'; font-size: 1em; font-weight: 600; }

        .card-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat-card { background: rgba(255, 255, 255, 0.95); border-radius: 16px; padding: 16px; text-align: center; box-shadow: 0 6px 12px rgba(0, 0, 0, 0.06); position: relative; overflow: hidden; }
        .stat-card::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .stat-card.income::after { background: var(--success); }
        .stat-card.expense::after { background: var(--danger); }
        .stat-card.savings::after { background: var(--warning); }
        .stat-card.available::after { background: var(--primary); }
        .stat-card.crisis { border: 2px solid var(--crisis); background: #FFF5F5; }
        .stat-label { color: var(--text-light); font-size: 0.75em; margin-bottom: 6px; text-transform: uppercase; font-weight: 600; }
        .stat-value { font-size: 1.4em; font-weight: 800; color: var(--text); }
        .stat-card.income .stat-value { color: var(--success); }
        .stat-card.expense .stat-value { color: var(--danger); }
        .crisis-badge { position: absolute; top: 8px; right: 8px; background: var(--crisis); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.65em; font-weight: 700; }

        h2 { font-family: 'Fredoka One', cursive; font-size: 1.3em; margin: 20px 0 12px 0; color: var(--primary-dark); display: flex; align-items: center; gap: 10px; text-shadow: 1px 1px 0px rgba(255,255,255,0.8); }
        h2 i { color: var(--primary); font-size: 0.9em; }

        .form-card { background: rgba(255, 255, 255, 0.95); border-radius: 16px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 16px; }
        .form-group { margin-bottom: 14px; }
        label { display: block; font-size: 0.85em; font-weight: 700; color: var(--text-light); margin-bottom: 6px; }
        input, select { width: 100%; padding: 12px; border: 2px solid var(--primary-light); border-radius: 12px; font-family: 'Poppins'; font-size: 1em; background: #FAFAFA; transition: border-color 0.2s; }
        input[type="date"] { -webkit-appearance: none; appearance: none; min-height: 48px; background-color: #FAFAFA; display: block; }
        input:focus, select:focus { outline: none; border-color: var(--primary); background: white; }
        button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-family: 'Poppins'; font-size: 1em; font-weight: 700; cursor: pointer; transition: transform 0.1s; box-shadow: 0 4px 10px rgba(123, 168, 168, 0.3); }
        button:active { transform: scale(0.96); }
        button.danger { background: var(--danger); box-shadow: 0 4px 10px rgba(245, 184, 184, 0.4); }
        
        .expense-type-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .type-btn { padding: 12px; border: 2px solid transparent; background: #F0F4F4; color: var(--text-light); border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 0.9em; }
        .type-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(123, 168, 168, 0.2); }

        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; margin-bottom: 14px; font-size: 0.9em; }
        th { padding: 0 10px; text-align: left; font-weight: 700; color: var(--text-light); font-size: 0.75em; text-transform: uppercase; background: rgba(255,255,255,0.5); border-radius: 4px; }
        td { padding: 12px 10px; background: rgba(255, 255, 255, 0.95); font-size: 0.9em; border-radius: 10px; }
        .btn-small { padding: 6px 10px; font-size: 0.8em; width: auto; background: #FFE0E0; color: #D65A5A; box-shadow: none; }

        /* Sections */
        .debt-card { background: white; border-radius: 14px; padding: 12px; margin-bottom: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #ccc; position: relative; }
        .debt-card.owe { border-left-color: var(--danger); } .debt-card.owed { border-left-color: var(--success); }
        .debt-card.paid { opacity: 0.6; border-left-color: #ccc; background: #f9f9f9; text-decoration: line-through; }
        .overdue-badge { position: absolute; top: -8px; right: 10px; background: var(--danger); color: white; font-size: 0.6em; padding: 2px 6px; border-radius: 4px; font-weight: 700; }
        .debt-info h4 { margin: 0; font-size: 1em; } .debt-info p { margin: 0; font-size: 0.75em; color: var(--text-light); }
        .debt-amount { font-weight: 800; font-size: 1.1em; } .owe .debt-amount { color: var(--danger); } .owed .debt-amount { color: var(--success); }
        .debt-actions { display: flex; gap: 5px; }
        .btn-check { background: var(--success); color: white; padding: 6px; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }

        .shopping-item { background: white; border-radius: 12px; padding: 12px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .shopping-item.checked { opacity: 0.6; background: #F0F4F4; text-decoration: line-through; color: var(--text-light); }
        .shop-actions { display: flex; gap: 8px; }
        .btn-buy { background: var(--primary); color: white; border-radius: 8px; padding: 5px 10px; font-size: 0.8em; font-weight: 600; }

        .goal-card { background: rgba(255, 255, 255, 0.95); border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.04); border: 1px solid transparent; }
        .goal-card.completed { border-color: var(--success); background: #F6FFF6; }
        .goal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .goal-name { font-size: 1.1em; font-weight: 800; color: var(--primary-dark); }
        .goal-status { font-size: 0.85em; color: var(--primary); font-weight: 700; background: var(--primary-light); padding: 4px 8px; border-radius: 8px; }
        .progress-bar { width: 100%; height: 10px; background: #F0F4F4; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--success)); width: 0%; border-radius: 10px; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .goal-amounts { display: flex; justify-content: space-between; margin: 12px 0; background: #FAFAFA; padding: 10px; border-radius: 10px; font-size: 0.9em; font-weight: 700; }
        .goal-buttons { display: flex; gap: 10px; margin-top: 10px; }
        .goal-buttons button:first-child { flex: 2; } .goal-buttons button:last-child { flex: 1; }

        /* Overlays */
        #bearOverlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 9999; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        #bearOverlay.show { opacity: 1; }
        .bear-anim-img { width: 300px; height: 300px; object-fit: contain; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.2)); }
        
        .celebration-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); display: flex; align-items: center; justify-content: center; pointer-events: none; z-index: 2000; }
        .celebration-message { background: white; color: var(--text); padding: 30px; border-radius: 20px; font-size: 1.5em; font-weight: 800; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.2); animation: popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); font-family: 'Fredoka One', cursive; }
        @keyframes popUp { 0% { opacity: 0; transform: scale(0.5); } 100% { opacity: 1; transform: scale(1); } }
        .empty-state { text-align: center; padding: 40px 16px; background: rgba(255, 255, 255, 0.8); border-radius: 16px; margin-top: 10px; }
        .empty-state-icon { font-size: 3em; margin-bottom: 12px; opacity: 0.6; color: var(--primary); }

        @media (max-width: 380px) { header h1 { font-size: 1.5em; } .stat-value { font-size: 1.2em; } }
    </style>
</head>
<body>
    <div id="bearOverlay">
        <img id="bearAnimImg" class="bear-anim-img" src="" alt="Bear" style="display:none;">
        <div id="bearEmojiBackup" style="font-size: 100px; display:none;"></div>
    </div>

    <div class="container">
        <header>
            <div class="header-text">
                <h1>The Money Game</h1>
                <p>Just do it <i class="fas fa-star" style="color:#FFD700;"></i></p>
            </div>
        </header>

        <div class="month-selector">
            <label for="monthInput"><i class="far fa-calendar-alt"></i></label>
            <input type="month" id="monthInput" onchange="changeMonth(this.value)">
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('dashboard', event)">
                <i class="fas fa-chart-pie"></i> Resumen
            </button>
            <button class="tab-btn" onclick="switchTab('income', event)">
                <i class="fas fa-wallet"></i> Ingresos
            </button>
            <button class="tab-btn" onclick="switchTab('expenses', event)">
                <i class="fas fa-money-bill-wave"></i> Gastos
            </button>
            <button class="tab-btn" onclick="switchTab('shopping', event)">
                <i class="fas fa-shopping-cart"></i> Compras
            </button>
            <button class="tab-btn" onclick="switchTab('debts', event)">
                <i class="fas fa-hand-holding-usd"></i> Deudas
            </button>
            <button class="tab-btn" onclick="switchTab('goals', event)">
                <i class="fas fa-bullseye"></i> Metas
            </button>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="card-grid">
                <div class="stat-card income">
                    <div class="stat-label">Ingresos</div>
                    <div class="stat-value" id="totalIncome">$0</div>
                </div>
                <div class="stat-card expense">
                    <div class="stat-label">Gastos</div>
                    <div class="stat-value" id="totalExpense">$0</div>
                </div>
                <div class="stat-card savings">
                    <div class="stat-label">Ahorrado Mes</div>
                    <div class="stat-value" id="totalAllocated">$0</div>
                </div>
                <div class="stat-card available" id="availableCard">
                    <div class="stat-label">Disponible</div>
                    <div class="stat-value" id="totalAvailable">$0</div>
                </div>
            </div>
            <div id="crisisAlert" style="display: none;">
                <div class="stat-card crisis">
                    <div class="crisis-badge">‚ö†Ô∏è ALERTA</div>
                    <div class="stat-label">¬°CUIDADO!</div>
                    <div class="stat-value" style="font-size: 1.2em;">Bajos Fondos</div>
                    <p style="font-size: 0.85em; color: var(--crisis); margin-top: 8px;">Te queda menos del 20%</p>
                </div>
            </div>
            <h2><i class="fas fa-trophy"></i> Progreso de Metas</h2>
            <div id="goalsProgress"></div>
            <div id="goalsProgressEmpty" class="empty-state" style="display:none;"><p>No hay metas activas.</p></div>
        </div>

        <div id="income" class="tab-content">
            <div class="form-card">
                <h2><i class="fas fa-plus-circle"></i> Nuevo Ingreso</h2>
                <div class="form-group"><label>Descripci√≥n</label><input type="text" id="incomeDescription" placeholder="Ej: Sueldo..."></div>
                <div class="form-group"><label>Monto</label><input type="number" id="incomeAmount" placeholder="0" min="0"></div>
                <div class="form-group">
                    <label>Frecuencia</label>
                    <div class="expense-type-selector">
                        <button class="type-btn active" onclick="setIncomeType(this, 'once')">Una vez</button>
                        <button class="type-btn" onclick="setIncomeType(this, 'recurring')">Mensual</button>
                    </div>
                    <input type="hidden" id="incomeType" value="once">
                </div>
                <button onclick="addTransaction('income')">Guardar <i class="fas fa-check"></i></button>
            </div>
            <h2>Historial</h2>
            <table id="incomeTable"><thead><tr><th>Item</th><th>Monto</th><th style="text-align:right;">Borrar</th></tr></thead><tbody id="incomeBody"></tbody></table>
            <div id="incomeEmpty" class="empty-state"><div class="empty-state-icon"><i class="fas fa-leaf"></i></div><p>Sin registros.</p></div>
        </div>

        <div id="expenses" class="tab-content">
            <div class="form-card">
                <h2><i class="fas fa-minus-circle"></i> Nuevo Gasto</h2>
                <div class="form-group"><label>¬øEn qu√© gastaste?</label><input type="text" id="expenseDescription" placeholder="Ej: Super..."></div>
                <div class="form-group"><label>Categor√≠a</label>
                    <select id="expenseCategory">
                        <option value="Comida">üçî Comida / Super</option>
                        <option value="Transporte">üöó Transporte</option>
                        <option value="Hogar">üè† Hogar / Cuentas</option>
                        <option value="Gustitos">üíñ Gustitos</option>
                        <option value="Salud">üíä Salud</option>
                        <option value="Suscripciones">üì∫ Suscripciones</option>
                        <option value="Otro">üìå Otro</option>
                    </select>
                </div>
                <div class="form-group"><label>Monto</label><input type="number" id="expenseAmount" placeholder="0" min="0"></div>
                <div class="form-group">
                    <label>Frecuencia</label>
                    <div class="expense-type-selector">
                        <button class="type-btn active" onclick="setExpenseType(this, 'once')">Una vez</button>
                        <button class="type-btn" onclick="setExpenseType(this, 'recurring')">Mensual</button>
                    </div>
                    <input type="hidden" id="expenseType" value="once">
                </div>
                <button onclick="addTransaction('expense')" style="background-color: var(--danger);">Registrar <i class="fas fa-arrow-right"></i></button>
            </div>
            <h2>Historial</h2>
            <table id="expenseTable"><thead><tr><th>Item</th><th>Monto</th><th style="text-align:right;">Borrar</th></tr></thead><tbody id="expenseBody"></tbody></table>
            <div id="expenseEmpty" class="empty-state"><div class="empty-state-icon"><i class="fas fa-magic"></i></div><p>Todo limpio.</p></div>
        </div>

        <div id="shopping" class="tab-content">
            <div class="form-card">
                <h2><i class="fas fa-shopping-cart"></i> Lista de Compras</h2>
                <div class="form-group"><input type="text" id="shopItem" placeholder="¬øQu√© necesitas comprar?"></div>
                <button onclick="addToShoppingList()">Agregar <i class="fas fa-plus"></i></button>
            </div>
            <h2>Por comprar</h2>
            <div id="shoppingContainer"></div>
            <div id="shoppingEmpty" class="empty-state"><div class="empty-state-icon"><i class="fas fa-clipboard-check"></i></div><p>Lista vac√≠a.</p></div>
        </div>

        <div id="debts" class="tab-content">
            <div class="form-card">
                <h2><i class="fas fa-handshake"></i> Registro de Deudas</h2>
                <div class="form-group">
                    <div class="expense-type-selector">
                        <button class="type-btn active" onclick="setDebtType(this, 'owed')">Me deben ü§ë</button>
                        <button class="type-btn" onclick="setDebtType(this, 'owe')">Yo debo üòì</button>
                    </div>
                    <input type="hidden" id="debtType" value="owed">
                </div>
                <div class="form-group"><label>Persona</label><input type="text" id="debtPerson" placeholder="Nombre..."></div>
                <div class="form-group"><label>Monto</label><input type="number" id="debtAmount" placeholder="0" min="0"></div>
                <div class="form-group"><label>Fecha</label><input type="date" id="debtDate"></div>
                <button onclick="addDebt()">Guardar <i class="fas fa-save"></i></button>
            </div>
            <h2>Pendientes</h2>
            <div id="debtsContainer"></div>
            <div id="debtsEmpty" class="empty-state"><div class="empty-state-icon"><i class="fas fa-peace"></i></div><p>Sin deudas.</p></div>
        </div>

        <div id="goals" class="tab-content">
            <div class="form-card">
                <h2><i class="fas fa-crosshairs"></i> Crear Meta</h2>
                <div class="form-group"><label>Nombre</label><input type="text" id="goalName" placeholder="Ej: Viaje..."></div>
                <div class="form-group"><label>Monto Meta</label><input type="number" id="goalAmount" placeholder="0" min="0"></div>
                <button onclick="addGoal()">Comenzar <i class="fas fa-rocket"></i></button>
            </div>
            <h2>Mis Objetivos</h2>
            <div id="goalsContainer"></div>
            <div id="goalsEmpty" class="empty-state"><div class="empty-state-icon"><i class="fas fa-mountain"></i></div><p>Define una meta.</p></div>
        </div>
    </div>

    <script>
        // --- DATA STRUCTURE ---
        let data = {
            currentMonth: new Date().toISOString().slice(0, 7),
            transactions: [],
            goals: [],
            debts: [],
            shopping: []
        };

        // --- APP INIT ---
        function initApp() {
            try {
                document.getElementById('monthInput').value = data.currentMonth;
                document.getElementById('debtDate').valueAsDate = new Date();
                loadData();
                render();
            } catch (error) {
                console.error("Error al iniciar:", error);
                localStorage.clear();
                location.reload();
            }
        }

        // --- CORE RECURRENCE LOGIC (AUTO-COPY) ---
        function checkRecurring() {
            const currentMonthKey = data.currentMonth; // "2026-02"
            
            // 1. Encontrar todas las transacciones que son recurrentes y son de meses pasados
            const templates = data.transactions.filter(t => t.isRecurring && t.date < (currentMonthKey + '-01'));

            let changes = false;
            templates.forEach(template => {
                // 2. Verificar si ya existe una copia en el mes actual (mismo nombre y tipo)
                const exists = data.transactions.some(t => 
                    t.date.startsWith(currentMonthKey) && 
                    t.description === template.description && 
                    t.type === template.type
                );

                // 3. Si no existe, crearla
                if (!exists) {
                    const newTx = { ...template }; // Copiar datos
                    newTx.id = Date.now() + Math.random(); // Nuevo ID √∫nico
                    newTx.date = currentMonthKey + '-01'; // Fecha del mes actual
                    data.transactions.push(newTx);
                    changes = true;
                }
            });
            
            if (changes) saveData();
        }

        // --- NAVIGATION ---
        function switchTab(tabName, event) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            const target = document.getElementById(tabName);
            if (target) target.classList.add('active');
            
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
        }

        function changeMonth(month) { 
            data.currentMonth = month; 
            checkRecurring(); // Check for recurring items when changing month
            render(); 
        }

        // --- DATA HELPERS ---
        function formatCurrency(amount) {
            if (isNaN(amount) || amount === null) return '$0';
            return '$' + parseFloat(amount).toLocaleString('es-CL', { maximumFractionDigits: 0 });
        }

        function saveData() { localStorage.setItem('moneyGameData_v2', JSON.stringify(data)); }
        
        function loadData() {
            const saved = localStorage.getItem('moneyGameData_v2');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    data = { ...data, ...parsed };
                    if(!Array.isArray(data.transactions)) data.transactions = [];
                    if(!Array.isArray(data.goals)) data.goals = [];
                    if(!Array.isArray(data.debts)) data.debts = [];
                    if(!Array.isArray(data.shopping)) data.shopping = [];
                } catch (e) {
                    console.error("Datos corruptos", e);
                }
            }
            checkRecurring(); // Check on load too
        }

        // --- LOGIC ---
        function addTransaction(type) {
            const isIncome = type === 'income';
            const descId = isIncome ? 'incomeDescription' : 'expenseDescription';
            const amountId = isIncome ? 'incomeAmount' : 'expenseAmount';
            const freqId = isIncome ? 'incomeType' : 'expenseType';
            
            const desc = document.getElementById(descId).value;
            const amount = parseFloat(document.getElementById(amountId).value);
            const freq = document.getElementById(freqId).value;
            const cat = isIncome ? 'Ingreso' : document.getElementById('expenseCategory').value;

            if (!desc || isNaN(amount)) return alert('Completa los campos');

            data.transactions.push({
                id: Date.now(), type, amount, description: desc, category: cat, isRecurring: freq === 'recurring', date: data.currentMonth + '-01'
            });

            document.getElementById(descId).value = '';
            document.getElementById(amountId).value = '';
            
            saveData(); render();
            showBearFeedback(isIncome ? 'happy' : 'sad');
            if(isIncome) switchTab('dashboard', null);
        }

        function deleteTransaction(id) {
            if(confirm('¬øBorrar?')) {
                data.transactions = data.transactions.filter(t => t.id !== id);
                saveData(); render();
            }
        }

        function addGoal() {
            const name = document.getElementById('goalName').value;
            const amount = parseFloat(document.getElementById('goalAmount').value);
            if (!name || isNaN(amount)) return alert('Datos inv√°lidos');
            data.goals.push({ id: Date.now(), name, targetAmount: amount, savedAmount: 0 });
            document.getElementById('goalName').value = '';
            document.getElementById('goalAmount').value = '';
            saveData(); render(); showBearFeedback('happy');
        }

        function addToGoal(id) {
            const amount = parseFloat(prompt('¬øCu√°nto abonas?'));
            if (!isNaN(amount) && amount > 0) {
                const goal = data.goals.find(g => g.id === id);
                if (goal) {
                    goal.savedAmount += amount;
                    saveData(); render();
                    showBearFeedback('happy');
                    if (goal.savedAmount >= goal.targetAmount) showCelebration('üéâ ¬°Meta Cumplida!');
                }
            }
        }

        function deleteGoal(id) {
            if(confirm('¬øBorrar meta?')) {
                data.goals = data.goals.filter(g => g.id !== id);
                saveData(); render();
            }
        }

        function addDebt() {
            const person = document.getElementById('debtPerson').value;
            const amount = parseFloat(document.getElementById('debtAmount').value);
            const date = document.getElementById('debtDate').value;
            const type = document.getElementById('debtType').value;
            
            if (!person || isNaN(amount) || !date) return alert('Completa todo');
            
            data.debts.push({ id: Date.now(), person, amount, date, type, status: 'pending' });
            
            document.getElementById('debtPerson').value = '';
            document.getElementById('debtAmount').value = '';
            saveData(); render(); showBearFeedback('sad');
        }

        function toggleDebtStatus(id) {
            const debt = data.debts.find(d => d.id === id);
            if (debt) {
                debt.status = debt.status === 'pending' ? 'paid' : 'pending';
                saveData(); render();
            }
        }

        function deleteDebt(id) {
            if(confirm('¬øBorrar?')) {
                data.debts = data.debts.filter(d => d.id !== id);
                saveData(); render();
            }
        }

        function addToShoppingList() {
            const item = document.getElementById('shopItem').value;
            if (!item) return;
            data.shopping.push({ id: Date.now(), name: item, checked: false });
            document.getElementById('shopItem').value = '';
            saveData(); renderShopping();
        }

        function toggleShopItem(id) {
            const item = data.shopping.find(i => i.id === id);
            if (item) { item.checked = !item.checked; saveData(); renderShopping(); }
        }

        function deleteShopItem(id) {
            data.shopping = data.shopping.filter(i => i.id !== id);
            saveData(); renderShopping();
        }

        function buyShopItem(id) {
            const item = data.shopping.find(i => i.id === id);
            if (!item) return;
            const price = parseFloat(prompt(`Precio de ${item.name}?`));
            if (!isNaN(price)) {
                data.transactions.push({
                    id: Date.now(), type: 'expense', amount: price, description: item.name, category: 'Comida', isRecurring: false, date: data.currentMonth + '-01'
                });
                data.shopping = data.shopping.filter(i => i.id !== id);
                saveData(); render(); showBearFeedback('sad');
            }
        }

        // --- RENDERERS ---
        function render() {
            const monthTx = data.transactions.filter(t => t.date.startsWith(data.currentMonth));
            
            let income = 0, expense = 0;
            monthTx.forEach(t => {
                if (t.type === 'income') income += t.amount;
                else expense += t.amount;
            });

            const totalSaved = data.goals.reduce((acc, g) => acc + g.savedAmount, 0);
            const available = income - expense;

            document.getElementById('totalIncome').textContent = formatCurrency(income);
            document.getElementById('totalExpense').textContent = formatCurrency(expense);
            document.getElementById('totalAllocated').textContent = formatCurrency(totalSaved);
            document.getElementById('totalAvailable').textContent = formatCurrency(available);

            const alert = document.getElementById('crisisAlert');
            alert.style.display = (income > 0 && (available/income) < 0.2) ? 'block' : 'none';

            renderTxList(monthTx.filter(t => t.type === 'income'), 'incomeBody', 'incomeEmpty', 'incomeTable');
            renderTxList(monthTx.filter(t => t.type === 'expense'), 'expenseBody', 'expenseEmpty', 'expenseTable');
            renderGoals(); renderGoalsProgress(); renderDebts(); renderShopping();
        }

        function renderTxList(list, bodyId, emptyId, tableId) {
            const tbody = document.getElementById(bodyId);
            const empty = document.getElementById(emptyId);
            const table = document.getElementById(tableId);
            
            tbody.innerHTML = '';
            if (list.length === 0) {
                empty.style.display = 'block';
                table.style.display = 'none';
            } else {
                empty.style.display = 'none';
                table.style.display = 'table';
                list.forEach(t => {
                    const icon = t.isRecurring ? '<i class="fas fa-sync-alt"></i>' : '';
                    const row = `<tr>
                        <td><b>${t.description}</b><br><span style="font-size:0.8em; color:#999">${t.category} ${icon}</span></td>
                        <td style="color:${t.type==='income'?'var(--success)':'var(--danger)'}; font-weight:700;">${formatCurrency(t.amount)}</td>
                        <td style="text-align:right;"><button class="btn-small" onclick="deleteTransaction(${t.id})"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            }
        }

        function renderDebts() {
            const container = document.getElementById('debtsContainer');
            const empty = document.getElementById('debtsEmpty');
            container.innerHTML = '';
            if (data.debts.length === 0) { empty.style.display = 'block'; return; }
            empty.style.display = 'none';
            
            const today = new Date();
            data.debts.forEach(d => {
                const diff = Math.ceil(Math.abs(today - new Date(d.date)) / (1000 * 60 * 60 * 24));
                const isOverdue = diff > 10 && d.status === 'pending';
                
                const card = `<div class="debt-card ${d.type} ${d.status} ${isOverdue ? 'overdue' : ''}">
                    ${isOverdue ? '<span class="overdue-badge">¬°VENCIDO!</span>' : ''}
                    <div class="debt-info"><h4>${d.person}</h4><p>${d.type==='owed'?'Me deben':'Debo'} ‚Ä¢ ${d.date}</p><div class="debt-amount">${formatCurrency(d.amount)}</div></div>
                    <div class="debt-actions"><button class="btn-check" onclick="toggleDebtStatus(${d.id})"><i class="fas fa-check"></i></button><button class="btn-small" onclick="deleteDebt(${d.id})"><i class="fas fa-trash"></i></button></div>
                </div>`;
                container.innerHTML += card;
            });
        }

        function renderShopping() {
            const container = document.getElementById('shoppingContainer');
            const empty = document.getElementById('shoppingEmpty');
            container.innerHTML = '';
            if (data.shopping.length === 0) { empty.style.display = 'block'; return; }
            empty.style.display = 'none';
            data.shopping.forEach(i => {
                container.innerHTML += `<div class="shopping-item ${i.checked ? 'checked' : ''}"><div onclick="toggleShopItem(${i.id})" style="flex:1; display:flex; align-items:center; gap:10px;"><i class="fas ${i.checked?'fa-check-square':'fa-square'}" style="color:var(--primary);"></i><span>${i.name}</span></div><div class="shop-actions"><button class="btn-buy" onclick="buyShopItem(${i.id})">Comprar</button><button class="btn-small" onclick="deleteShopItem(${i.id})"><i class="fas fa-trash"></i></button></div></div>`;
            });
        }

        function renderGoals() {
            const container = document.getElementById('goalsContainer');
            const empty = document.getElementById('goalsEmpty');
            container.innerHTML = '';
            if (data.goals.length === 0) { empty.style.display = 'block'; return; }
            empty.style.display = 'none';
            data.goals.forEach(g => {
                const pct = Math.min((g.savedAmount / g.targetAmount) * 100, 100);
                container.innerHTML += `<div class="goal-card ${pct>=100?'completed':''}"><div class="goal-header"><div class="goal-name">${g.name}</div><div class="goal-status">${pct.toFixed(0)}%</div></div><div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div><div class="goal-amounts"><div>Ahorrado<br>${formatCurrency(g.savedAmount)}</div><div>Meta<br>${formatCurrency(g.targetAmount)}</div></div><div class="goal-buttons"><button onclick="addToGoal(${g.id})">Ahorrar</button><button class="danger btn-small" onclick="deleteGoal(${g.id})"><i class="fas fa-trash"></i></button></div></div>`;
            });
        }

        function renderGoalsProgress() {
            const container = document.getElementById('goalsProgress');
            const empty = document.getElementById('goalsProgressEmpty');
            container.innerHTML = '';
            let hasActive = false;
            data.goals.forEach(g => {
                const pct = Math.min((g.savedAmount / g.targetAmount) * 100, 100);
                if (pct < 100) {
                    hasActive = true;
                    container.innerHTML += `<div style="margin-bottom:10px; background:white; padding:10px; border-radius:10px;"><div style="display:flex; justify-content:space-between; font-size:0.9em; font-weight:700; margin-bottom:5px;"><span>${g.name}</span><span>${pct.toFixed(0)}%</span></div><div class="progress-bar" style="height:6px; margin:0;"><div class="progress-fill" style="width:${pct}%"></div></div></div>`;
                }
            });
            empty.style.display = hasActive ? 'none' : 'block';
        }

        // --- UI HELPERS ---
        function setIncomeType(btn, type) {
            btn.parentElement.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('incomeType').value = type;
        }
        function setExpenseType(btn, type) {
            btn.parentElement.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('expenseType').value = type;
        }
        function setDebtType(btn, type) {
            btn.parentElement.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('debtType').value = type;
        }

        function showBearFeedback(type) {
            const overlay = document.getElementById('bearOverlay');
            const img = document.getElementById('bearAnimImg');
            const back = document.getElementById('bearEmojiBackup');
            overlay.classList.add('show');
            if(type === 'happy') { img.src = './happy.gif'; back.textContent = 'üêªüéâ'; }
            else { img.src = './sad.gif'; back.textContent = 'üêªüíß'; }
            img.onload = () => { img.style.display = 'block'; back.style.display = 'none'; };
            img.onerror = () => { img.style.display = 'none'; back.style.display = 'block'; };
            setTimeout(() => overlay.classList.remove('show'), 2500);
        }

        function showCelebration(msg) {
            const div = document.createElement('div');
            div.className = 'celebration-overlay';
            div.innerHTML = `<div class="celebration-message">${msg}</div>`;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        // START
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(e => console.log(e)); });
        }
        initApp();
    </script>
</body>
</html>
