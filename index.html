<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="The Money Game">
    <meta name="theme-color" content="#7BA8A8">
    
    <link rel="apple-touch-icon" href="./icon.png">
    <link rel="icon" type="image/png" href="./icon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="./manifest.json">

    <title>The Money Game üêª</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; -webkit-user-select: none; user-select: none; }
        html, body { width: 100%; height: 100%; overflow: hidden; }

        :root {
            --primary: #7BA8A8;
            --primary-light: #D4E8E8;
            --primary-dark: #5A8080;
            --success: #9BC997;
            --warning: #F5D5A8;
            --danger: #F5B8B8;
            --bg: #FBF6F0;
            --surface: #FFFFFF;
            --text: #3D3D3D;
            --text-light: #8B8B7A;
            --border-color: #C9A88A;
            --crisis: #E74C3C;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg);
            background-image: url('./fondo.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text);
            display: flex; flex-direction: column; height: 100vh;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        .container { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 12px; padding-bottom: 120px; }

        /* HEADER */
        header {
            background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('./banner.png');
            background-size: cover; background-position: center;
            border-radius: 24px; padding: 40px 20px; margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0, 0.15); border: 2px solid rgba(255,255,255,0.6);
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        .header-text h1 { font-family: 'Fredoka One', cursive; font-size: 2.2em; color: #FFFFFF; line-height: 1; margin-bottom: 5px; text-shadow: 0px 2px 4px rgba(0,0,0,0.6); }
        .header-text p { font-size: 0.9em; color: rgba(255, 255, 255, 0.9); font-weight: 600; text-shadow: 0px 1px 2px rgba(0,0,0,0.6); }

        /* UI ELEMENTS */
        .month-selector { background: rgba(255, 255, 255, 0.95); padding: 10px 14px; border-radius: 12px; margin-bottom: 12px; display: flex; gap: 12px; align-items: center; border: 2px solid var(--border-color); box-shadow: 0 4px 10px rgba(0,0,0,0.03); backdrop-filter: blur(5px); }
        .month-selector label { font-weight: 700; color: var(--primary); font-size: 1.2em; }
        .month-selector input { flex: 1; border: none; background: transparent; padding: 8px; font-family: 'Poppins'; color: var(--text); font-size: 1em; font-weight: 600; }

        /* TABS FIXED */
        .tabs { display: flex; gap: 10px; margin-bottom: 18px; overflow-x: auto; border-radius: 16px; padding: 4px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab-btn { padding: 10px 16px; border: none; background: rgba(255, 255, 255, 0.90); cursor: pointer; font-size: 0.85em; color: var(--text); border-radius: 12px; transition: all 0.2s; font-family: 'Poppins'; font-weight: 700; white-space: nowrap; border: 1px solid transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(123, 168, 168, 0.4); transform: translateY(-1px); }

        .tab-content { display: none; animation: slideIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* FORMS & INPUTS */
        .form-card { background: rgba(255, 255, 255, 0.95); border-radius: 16px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 16px; border: 1px solid rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 14px; }
        label { display: block; font-size: 0.85em; font-weight: 700; color: var(--text-light); margin-bottom: 6px; }
        input, select { width: 100%; padding: 12px; border: 2px solid var(--primary-light); border-radius: 12px; font-family: 'Poppins'; font-size: 1em; background: #FAFAFA; color: var(--text); transition: border-color 0.2s; }
        input[type="date"] { -webkit-appearance: none; appearance: none; min-height: 48px; background-color: #FAFAFA; display: block; line-height: 1.2; }
        input:focus, select:focus { outline: none; border-color: var(--primary); background: white; }
        button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-family: 'Poppins'; font-size: 1em; font-weight: 700; cursor: pointer; transition: transform 0.1s, background 0.2s; box-shadow: 0 4px 10px rgba(123, 168, 168, 0.3); }
        button:active { transform: scale(0.96); }
        button.danger { background: var(--danger); box-shadow: 0 4px 10px rgba(245, 184, 184, 0.4); }
        
        .expense-type-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .type-btn { padding: 12px; border: 2px solid transparent; background: #F0F4F4; color: var(--text-light); border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 0.9em; box-shadow: none; }
        .type-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(123, 168, 168, 0.2); }

        /* LISTS & TABLES */
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; margin-bottom: 14px; font-size: 0.9em; }
        th { padding: 0 10px; text-align: left; font-weight: 700; color: var(--text-light); font-size: 0.75em; text-transform: uppercase; background: rgba(255,255,255,0.5); border-radius: 4px; }
        td { padding: 12px 10px; background: rgba(255, 255, 255, 0.95); font-size: 0.9em; border-top: 1px solid rgba(0,0,0,0.03); border-bottom: 1px solid rgba(0,0,0,0.03); }
        td:first-child { border-radius: 10px 0 0 10px; border-left: 1px solid rgba(0,0,0,0.03); }
        td:last-child { border-radius: 0 10px 10px 0; border-right: 1px solid rgba(0,0,0,0.03); text-align: right; }
        .btn-small { padding: 6px 10px; font-size: 0.8em; width: auto; box-shadow: none; background: #FFE0E0; color: #D65A5A; }

        /* STAT CARDS */
        .card-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px); border-radius: 16px; padding: 16px; border: none; text-align: center; box-shadow: 0 6px 12px rgba(0, 0, 0, 0.06); position: relative; overflow: hidden; }
        .stat-card::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .stat-card.income::after { background: var(--success); }
        .stat-card.expense::after { background: var(--danger); }
        .stat-card.savings::after { background: var(--warning); }
        .stat-card.available::after { background: var(--primary); }
        .stat-card.crisis { border: 2px solid var(--crisis); background: #FFF5F5; animation: pulse-crisis 1.5s ease-in-out infinite; }
        @keyframes pulse-crisis { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        .stat-label { color: var(--text-light); font-size: 0.75em; margin-bottom: 6px; text-transform: uppercase; font-weight: 600; }
        .stat-value { font-size: 1.4em; font-weight: 800; color: var(--text); }
        .stat-card.income .stat-value { color: var(--success); }
        .stat-card.expense .stat-value { color: var(--danger); }
        .stat-card.savings .stat-value { color: #E6B328; }
        .stat-card.available .stat-value { color: var(--primary-dark); }
        .stat-card.crisis .stat-value { color: var(--crisis); }
        .crisis-badge { position: absolute; top: 8px; right: 8px; background: var(--crisis); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.65em; font-weight: 700; }

        h2 { font-family: 'Fredoka One', cursive; font-size: 1.3em; margin: 20px 0 12px 0; color: var(--primary-dark); display: flex; align-items: center; gap: 10px; text-shadow: 1px 1px 0px rgba(255,255,255,0.8); }
        h2 i { color: var(--primary); font-size: 0.9em; }

        /* DEBTS & SHOPPING */
        .debt-card { background: white; border-radius: 14px; padding: 12px; margin-bottom: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #ccc; position: relative; }
        .debt-card.owe { border-left-color: var(--danger); }
        .debt-card.owed { border-left-color: var(--success); }
        .debt-card.paid { opacity: 0.6; border-left-color: #ccc; background: #f9f9f9; }
        .debt-card.paid .debt-info { text-decoration: line-through; }
        .debt-card.overdue { border: 2px solid var(--danger); background: #FFF5F5; }
        .overdue-badge { position: absolute; top: -8px; right: 10px; background: var(--danger); color: white; font-size: 0.6em; padding: 2px 6px; border-radius: 4px; font-weight: 700; }
        .debt-info h4 { margin: 0; font-size: 1em; color: var(--text); }
        .debt-info p { margin: 0; font-size: 0.75em; color: var(--text-light); }
        .debt-amount { font-weight: 800; font-size: 1.1em; }
        .owe .debt-amount { color: var(--danger); }
        .owed .debt-amount { color: var(--success); }
        .debt-actions { display: flex; gap: 5px; }
        .btn-check { background: var(--success); color: white; padding: 6px; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }

        .shopping-item { background: white; border-radius: 12px; padding: 12px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .shopping-item.checked { opacity: 0.6; background: #F0F4F4; }
        .shopping-item.checked span { text-decoration: line-through; color: var(--text-light); }
        .shop-actions { display: flex; gap: 8px; }
        .btn-buy { background: var(--primary); color: white; border-radius: 8px; padding: 5px 10px; font-size: 0.8em; font-weight: 600; }

        /* GOALS */
        .progress-bar { width: 100%; height: 10px; background: #F0F4F4; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--success)); width: 0%; border-radius: 10px; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .goal-card { background: rgba(255, 255, 255, 0.95); border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.04); border: 1px solid transparent; transition: transform 0.2s; }
        .goal-card:active { transform: scale(0.99); }
        .goal-card.completed { border-color: var(--success); background: #F6FFF6; }
        .goal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .goal-name { font-size: 1.1em; font-weight: 800; color: var(--primary-dark); }
        .goal-status { font-size: 0.85em; color: var(--primary); font-weight: 700; background: var(--primary-light); padding: 4px 8px; border-radius: 8px; }
        .goal-amounts { display: flex; justify-content: space-between; margin: 12px 0; text-align: left; background: #FAFAFA; padding: 10px; border-radius: 10px; }
        .goal-amount div:first-child { color: var(--text-light); font-size: 0.7em; margin-bottom: 2px; }
        .goal-amount div:last-child { font-weight: 700; color: var(--text); font-size: 0.95em; }
        .goal-buttons { display: flex; gap: 10px; margin-top: 10px; }
        .goal-buttons button:first-child { flex: 2; }
        .goal-buttons button:last-child { flex: 1; }

        /* BEAR ANIMATION */
        #bearOverlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 9999; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        #bearOverlay.show { opacity: 1; }
        .bear-anim-img { width: 300px; height: 300px; object-fit: contain; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.2)); }
        
        /* CONFETTI */
        @keyframes confetti-fall { 0% { opacity: 1; transform: translateY(0) rotateZ(0deg); } 100% { opacity: 0; transform: translateY(600px) rotateZ(720deg); } }
        .confetti { position: fixed; pointer-events: none; animation: confetti-fall 3s ease-in forwards; z-index: 9999; }
        .celebration-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); display: flex; align-items: center; justify-content: center; pointer-events: none; z-index: 2000; }
        .celebration-message { background: white; color: var(--text); padding: 30px; border-radius: 20px; font-size: 1.5em; font-weight: 800; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.2); animation: slideInPulse 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); font-family: 'Fredoka One', cursive; }
        @keyframes slideInPulse { 0% { opacity: 0; transform: scale(0.5); } 100% { opacity: 1; transform: scale(1); } }
        
        .empty-state { text-align: center; padding: 40px 16px; color: var(--text-light); background: rgba(255, 255, 255, 0.8); border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .empty-state-icon { font-size: 3em; margin-bottom: 12px; opacity: 0.6; color: var(--primary); }

        @media (max-width: 380px) { header h1 { font-size: 1.5em; } .stat-value { font-size: 1.2em; } }
    </style>
    
    <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(e => console.log(e));
      });
    }
    </script>
</head>
<body>
    <div id="bearOverlay">
        <img id="bearAnimImg" class="bear-anim-img" src="" alt="Bear" style="display:none;">
        <div id="bearEmojiBackup" style="font-size: 120px; display:none;"></div>
    </div>

    <div class="container">
        <header>
            <div class="header-text">
                <h1>The Money Game</h1>
                <p>Just do it <i class="fas fa-star" style="color:#FFD700;"></i></p>
            </div>
        </header>

        <div class="month-selector">
            <label for="monthInput"><i class="far fa-calendar-alt"></i></label>
            <input type="month" id="monthInput" onchange="changeMonth(this.value)">
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('dashboard', event)">
                <i class="fas fa-chart-pie"></i> Resumen
            </button>
            <button class="tab-btn" onclick="switchTab('income', event)">
                <i class="fas fa-wallet"></i> Ingresos
            </button>
            <button class="tab-btn" onclick="switchTab('expenses', event)">
                <i class="fas fa-money-bill-wave"></i> Gastos
            </button>
            <button class="tab-btn" onclick="switchTab('shopping', event)">
                <i class="fas fa-shopping-cart"></i> Compras
            </button>
            <button class="tab-btn" onclick="switchTab('debts', event)">
                <i class="fas fa-hand-holding-usd"></i> Deudas
            </button>
            <button class="tab-btn" onclick="switchTab('goals', event)">
                <i class="fas fa-bullseye"></i> Metas
            </button>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="card-grid">
                <div class="stat-card income">
                    <div class="stat-label">Ingresos</div>
                    <div class="stat-value" id="totalIncome">$0</div>
                </div>
                <div class="stat-card expense">
                    <div class="stat-label">Gastos</div>
                    <div class="stat-value" id="totalExpense">$0</div>
                </div>
                <div class="stat-card savings">
                    <div class="stat-label">Ahorrado Mes</div>
                    <div class="stat-value" id="totalAllocated">$0</div>
                </div>
                <div class="stat-card available" id="availableCard">
                    <div class="stat-label">Disponible</div>
                    <div class="stat-value" id="totalAvailable">$0</div>
                </div>
            </div>

            <div id="crisisAlert" style="display: none;">
                <div class="stat-card crisis">
                    <div class="crisis-badge"><i class="fas fa-exclamation-triangle"></i> ALERTA</div>
                    <div class="stat-label">¬°CUIDADO!</div>
                    <div class="stat-value" style="font-size: 1.2em;">Bajos Fondos</div>
                    <p style="font-size: 0.85em; color: var(--crisis); margin-top: 8px; line-height: 1.4;">Te queda menos del 20% de tu dinero disponible.</p>
                </div>
            </div>

            <h2><i class="fas fa-trophy"></i> Progreso de Metas</h2>
            <div id="goalsProgress"></div>
            <div id="goalsProgressEmpty" class="empty-state" style="display:none; padding: 20px;">
                <p>No tienes metas activas a√∫n.</p>
            </div>
        </div>

        <div id="income" class="tab-content">
            <div class="form-card">
                <h2><i class="fas fa-plus-circle"></i> Nuevo Ingreso</h2>
                <div class="form-group">
                    <label>Descripci√≥n</label>
                    <input type="text" id="incomeDescription" placeholder="Ej: Sueldo, Venta...">
                </div>
                <div class="form-group">
                    <label>Monto</label>
                    <input type="number" id="incomeAmount" placeholder="0" min="0">
                </div>
                <div class="form-group">
                    <label>Frecuencia</label>
                    <div class="expense-type-selector">
                        <button class="type-btn active" onclick="setIncomeType(this, 'once')">Una vez</button>
                        <button class="type-btn" onclick="setIncomeType(this, 'recurring')">Mensual</button>
                    </div>
                    <input type="hidden" id="incomeType" value="once">
                </div>
                <button onclick="addTransaction('income')">Guardar Ingreso <i class="fas fa-check"></i></button>
            </div>

            <h2>Historial del Mes</h2>
            <table id="incomeTable">
                <thead>
                    <tr><th>Item</th><th>Monto</th><th style="text-align: right;">Borrar</th></tr>
                </thead>
                <tbody id="incomeBody"></tbody>
            </table>
            <div id="incomeEmpty" class="empty-state">
                <div class="empty-state-icon"><i class="fas fa-leaf"></i></div>
                <p>Nada por aqu√≠ a√∫n.</p>
            </div>
        </div>

        <div id="expenses" class="tab-content">
            <div class="form-card">
                <h2><i class="fas fa-minus-circle"></i> Nuevo Gasto</h2>
                <div class="form-group">
                    <label>¬øEn qu√© gastaste?</label>
                    <input type="text" id="expenseDescription" placeholder="Ej: Supermercado...">
                </div>
                <div class="form-group">
                    <label>Categor√≠a</label>
                    <select id="expenseCategory">
                        <option value="Comida">üçî Comida / Super</option>
                        <option value="Transporte">üöó Transporte</option>
                        <option value="Hogar">üè† Hogar / Cuentas</option>
                        <option value="Gustitos">üíñ Gustitos</option>
                        <option value="Salud">üíä Salud</option>
                        <option value="Suscripciones">üì∫ Suscripciones</option>
                        <option value="Otro">üìå Otro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Monto</label>
                    <input type="number" id="expenseAmount" placeholder="0" min="0">
                </div>
                <div class="form-group">
                    <label>Frecuencia</label>
                    <div class="expense-type-selector">
                        <button class="type-btn active" onclick="setExpenseType(this, 'once')">Una vez</button>
                        <button class="type-btn" onclick="setExpenseType(this, 'recurring')">Mensual</button>
                    </div>
                    <input type="hidden" id="expenseType" value="once">
                </div>
                <button onclick="addTransaction('expense')" style="background-color: var(--danger);">Registrar Gasto <i class="fas fa-arrow-right"></i></button>
            </div>

            <h2>Gastos del Mes</h2>
            <table id="expenseTable">
                <thead>
                    <tr><th>Item</th><th>Monto</th><th style="text-align: right;">Borrar</th></tr>
                </thead>
                <tbody id="expenseBody"></tbody>
            </table>
            <div id="expenseEmpty" class="empty-state">
                <div class="empty-state-icon"><i class="fas fa-magic"></i></div>
                <p>¬°Todo limpio! Sin gastos.</p>
            </div>
        </div>

        <div id="shopping" class="tab-content">
            <div class="form-card">
                <h2><i class="fas fa-shopping-cart"></i> Lista de Compras</h2>
                <div class="form-group">
                    <input type="text" id="shopItem" placeholder="¬øQu√© necesitas comprar?">
                </div>
                <button onclick="addToShoppingList()">Agregar a la lista <i class="fas fa-plus"></i></button>
            </div>
            <h2>Por comprar</h2>
            <div id="shoppingContainer"></div>
            <div id="shoppingEmpty" class="empty-state">
                <div class="empty-state-icon"><i class="fas fa-clipboard-check"></i></div>
                <p>Tu lista est√° vac√≠a.</p>
            </div>
        </div>

        <div id="debts" class="tab-content">
            <div class="form-card">
                <h2><i class="fas fa-handshake"></i> Registro de Deudas</h2>
                <div class="form-group">
                    <div class="expense-type-selector">
                        <button class="type-btn active" onclick="setDebtType(this, 'owed')">Me deben ü§ë</button>
                        <button class="type-btn" onclick="setDebtType(this, 'owe')">Yo debo üòì</button>
                    </div>
                    <input type="hidden" id="debtType" value="owed">
                </div>
                <div class="form-group">
                    <label>Persona</label>
                    <input type="text" id="debtPerson" placeholder="Nombre...">
                </div>
                <div class="form-group">
                    <label>Monto</label>
                    <input type="number" id="debtAmount" placeholder="0" min="0">
                </div>
                <div class="form-group">
                    <label>Fecha del pr√©stamo</label>
                    <input type="date" id="debtDate">
                </div>
                <button onclick="addDebt()">Guardar Deuda <i class="fas fa-save"></i></button>
            </div>
            <h2>Pendientes</h2>
            <div id="debtsContainer"></div>
            <div id="debtsEmpty" class="empty-state">
                <div class="empty-state-icon"><i class="fas fa-peace"></i></div>
                <p>Sin deudas pendientes.</p>
            </div>
        </div>

        <div id="goals" class="tab-content">
            <div class="form-card">
                <h2><i class="fas fa-crosshairs"></i> Crear Meta</h2>
                <div class="form-group">
                    <label>Nombre de la Meta</label>
                    <input type="text" id="goalName" placeholder="Ej: PC Gamer, Viaje...">
                </div>
                <div class="form-group">
                    <label>Monto a juntar</label>
                    <input type="number" id="goalAmount" placeholder="0" min="0">
                </div>
                <button onclick="addGoal()">Comenzar Meta <i class="fas fa-rocket"></i></button>
            </div>
            <h2>Mis Objetivos</h2>
            <div id="goalsContainer"></div>
            <div id="goalsEmpty" class="empty-state">
                <div class="empty-state-icon"><i class="fas fa-mountain"></i></div>
                <p>Define una meta para empezar.</p>
            </div>
        </div>
    </div>

    <script>
        // --- DATA STRUCTURE (PROFESSIONAL FLAT MODEL) ---
        let data = {
            currentMonth: new Date().toISOString().slice(0, 7),
            transactions: [], // { id, type, amount, description, category, date, recurring }
            goals: [],        // { id, name, targetAmount, savedAmount }
            debts: [],        // { id, person, amount, date, type, status }
            shopping: []      // { id, name, checked }
        };

        // --- APP INITIALIZATION ---
        function initApp() {
            document.getElementById('monthInput').value = data.currentMonth;
            document.getElementById('debtDate').valueAsDate = new Date();
            loadData();
            render();
        }

        function saveData() { localStorage.setItem('moneyGameData_v2', JSON.stringify(data)); }
        function loadData() {
            const saved = localStorage.getItem('moneyGameData_v2');
            if (saved) {
                data = JSON.parse(saved);
            } else {
                // Migration logic (Optional, for now we start fresh or keep empty)
                const oldData = localStorage.getItem('financialData');
                if (oldData) { console.log("Old data found but starting fresh with V2 structure for stability."); }
            }
        }

        // --- NAVIGATION ---
        function switchTab(tabName, event) {
            // Remove active class from all content and buttons
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            // Activate selected
            const targetContent = document.getElementById(tabName);
            if(targetContent) targetContent.classList.add('active');
            
            if(event && event.currentTarget) event.currentTarget.classList.add('active');
        }

        function changeMonth(month) { data.currentMonth = month; render(); }

        // --- TYPE SETTERS ---
        function setIncomeType(btn, type) {
            btn.parentElement.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('incomeType').value = type;
        }
        function setExpenseType(btn, type) {
            btn.parentElement.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('expenseType').value = type;
        }
        function setDebtType(btn, type) {
            btn.parentElement.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('debtType').value = type;
        }

        // --- FORMATTING ---
        function formatCurrency(amount) {
            return '$' + amount.toLocaleString('es-CL', { maximumFractionDigits: 0 });
        }

        // --- TRANSACTIONS (INCOME & EXPENSE) ---
        function addTransaction(type) {
            const isIncome = type === 'income';
            const descInput = document.getElementById(isIncome ? 'incomeDescription' : 'expenseDescription');
            const amountInput = document.getElementById(isIncome ? 'incomeAmount' : 'expenseAmount');
            const typeInput = document.getElementById(isIncome ? 'incomeType' : 'expenseType');
            const catInput = isIncome ? null : document.getElementById('expenseCategory');

            const description = descInput.value;
            const amount = parseFloat(amountInput.value);
            const freq = typeInput.value;
            const category = catInput ? catInput.value : 'Ingreso';

            if (!description || !amount) return alert('Completa los campos üôè');

            const newTx = {
                id: Date.now(),
                type: type, // 'income' or 'expense'
                amount: amount,
                description: description,
                category: category,
                isRecurring: freq === 'recurring',
                date: data.currentMonth + '-01' // Assign to current selected month
            };

            data.transactions.push(newTx);
            
            // Reset fields
            descInput.value = '';
            amountInput.value = '';
            
            saveData();
            render();
            showBearFeedback(isIncome ? 'happy' : 'sad');
            if(isIncome) document.querySelector('.tab-btn.active').click(); 
        }

        function deleteTransaction(id) {
            if(confirm('¬øBorrar este registro?')) {
                data.transactions = data.transactions.filter(t => t.id !== id);
                saveData();
                render();
            }
        }

        // --- GOALS ---
        function addGoal() {
            const name = document.getElementById('goalName').value;
            const amount = parseFloat(document.getElementById('goalAmount').value);
            if (!name || !amount) return alert('Completa los campos üôè');

            data.goals.push({
                id: Date.now(),
                name: name,
                targetAmount: amount,
                savedAmount: 0 // In flat structure, we could link txs, but simplified here
            });

            document.getElementById('goalName').value = '';
            document.getElementById('goalAmount').value = '';
            saveData();
            render();
            showBearFeedback('happy');
        }

        function addToGoal(id) {
            const amount = parseFloat(prompt('¬øCu√°nto vas a abonar hoy? üí∞'));
            if (amount && amount > 0) {
                const goal = data.goals.find(g => g.id == id);
                if(goal) {
                    goal.savedAmount += amount;
                    // Also record as an expense? Ideally yes, but let's keep it simple for now
                    // Or we could create a "Transfer" transaction type.
                    // For now just tracking progress.
                    saveData();
                    render();
                    if (goal.savedAmount >= goal.targetAmount) {
                        showCelebration('üêª ¬°Meta Completada! üêª');
                        showBearFeedback('happy');
                    } else {
                        showBearFeedback('happy');
                    }
                }
            }
        }

        function deleteGoal(id) {
            if(confirm('¬øEliminar meta?')) {
                data.goals = data.goals.filter(g => g.id != id);
                saveData();
                render();
            }
        }

        // --- DEBTS ---
        function addDebt() {
            const person = document.getElementById('debtPerson').value;
            const amount = parseFloat(document.getElementById('debtAmount').value);
            const date = document.getElementById('debtDate').value;
            const type = document.getElementById('debtType').value;

            if (!person || !amount || !date) return alert('Faltan datos');

            data.debts.push({
                id: Date.now(),
                person, amount, date, type, status: 'pending'
            });

            document.getElementById('debtPerson').value = '';
            document.getElementById('debtAmount').value = '';
            saveData();
            render();
            showBearFeedback('sad');
        }

        function toggleDebtStatus(id) {
            const debt = data.debts.find(d => d.id == id);
            if (debt) {
                debt.status = debt.status === 'pending' ? 'paid' : 'pending';
                saveData();
                render();
                if(debt.status === 'paid') showCelebration('¬°Deuda Saldada! üí∏');
            }
        }

        function deleteDebt(id) {
            if(confirm('¬øBorrar deuda?')) {
                data.debts = data.debts.filter(d => d.id != id);
                saveData();
                render();
            }
        }

        // --- SHOPPING ---
        function addToShoppingList() {
            const item = document.getElementById('shopItem').value;
            if (!item) return;
            data.shopping.push({ id: Date.now(), name: item, checked: false });
            document.getElementById('shopItem').value = '';
            saveData();
            renderShopping();
        }

        function toggleShopItem(id) {
            const item = data.shopping.find(i => i.id == id);
            if (item) { item.checked = !item.checked; saveData(); renderShopping(); }
        }

        function deleteShopItem(id) {
            data.shopping = data.shopping.filter(i => i.id != id);
            saveData(); renderShopping();
        }

        function buyShopItem(id) {
            const item = data.shopping.find(i => i.id == id);
            if (!item) return;
            const price = prompt(`¬øCu√°nto cost√≥ "${item.name}"?`);
            if (price !== null && price !== "") {
                const amount = parseFloat(price);
                if (isNaN(amount)) return alert("Monto inv√°lido");
                
                // Add to expenses
                data.transactions.push({
                    id: Date.now(),
                    type: 'expense',
                    amount: amount,
                    description: item.name,
                    category: 'Comida', // Default
                    isRecurring: false,
                    date: data.currentMonth + '-01'
                });

                // Remove from shopping
                data.shopping = data.shopping.filter(i => i.id != id);
                
                saveData();
                render();
                showBearFeedback('sad');
            }
        }

        // --- RENDER ENGINE (CORE) ---
        function render() {
            // 1. Filter Transactions by Month
            const monthTxs = data.transactions.filter(t => t.date.startsWith(data.currentMonth));
            
            // 2. Calculate Totals
            let income = 0, expenses = 0, savings = 0;
            monthTxs.forEach(t => {
                if(t.type === 'income') income += t.amount;
                if(t.type === 'expense') expenses += t.amount;
            });
            
            // Calculate savings based on goals contributions in this month? 
            // For simpler logic, let's sum total saved across all goals for display, 
            // OR we treat "Available" as Income - Expense.
            // Let's stick to the "Available = Income - Expense" model for simplicity + Goal contributions if we tracked them as expenses.
            
            // Let's assume Savings = Sum of all goal.savedAmount (Total Life Savings) or Monthly allocation?
            // To keep it clean: "Ahorrado Mes" needs transaction tracking. 
            // For now, let's display "Total Ahorrado" from all goals.
            const totalSavedInGoals = data.goals.reduce((acc, g) => acc + g.savedAmount, 0);
            
            const available = income - expenses; // Strictly cash flow

            // 3. Update Dashboard
            document.getElementById('totalIncome').textContent = formatCurrency(income);
            document.getElementById('totalExpense').textContent = formatCurrency(expenses);
            document.getElementById('totalAllocated').textContent = formatCurrency(totalSavedInGoals);
            document.getElementById('totalAvailable').textContent = formatCurrency(available);

            const card = document.getElementById('availableCard');
            const alert = document.getElementById('crisisAlert');
            if (income > 0 && (available / income) < 0.2) {
                card.classList.add('crisis');
                alert.style.display = 'block';
            } else {
                card.classList.remove('crisis');
                alert.style.display = 'none';
            }

            // 4. Render Lists
            renderTxList(monthTxs.filter(t => t.type === 'income'), 'incomeBody', 'incomeEmpty', 'incomeTable');
            renderTxList(monthTxs.filter(t => t.type === 'expense'), 'expenseBody', 'expenseEmpty', 'expenseTable');
            renderDebts();
            renderGoals();
            renderGoalsProgress();
            renderShopping();
        }

        function renderTxList(list, bodyId, emptyId, tableId) {
            const tbody = document.getElementById(bodyId);
            const empty = document.getElementById(emptyId);
            const table = document.getElementById(tableId);
            
            tbody.innerHTML = '';
            if(list.length === 0) {
                empty.style.display = 'block';
                table.style.display = 'none';
            } else {
                empty.style.display = 'none';
                table.style.display = 'table';
                list.forEach(t => {
                    const icon = t.isRecurring ? '<i class="fas fa-sync-alt"></i>' : '';
                    const catDisplay = t.type === 'expense' ? `${t.category} ${icon}` : (t.isRecurring ? 'Mensual' : '√önico');
                    const color = t.type === 'income' ? 'var(--success)' : 'var(--danger)';
                    const sign = t.type === 'income' ? '+' : '-';
                    
                    const row = `
                    <tr>
                        <td><b>${t.description}</b><br><span style="font-size:0.8em; color:#999">${catDisplay}</span></td>
                        <td style="color:${color}; font-weight:700;">${sign}${formatCurrency(t.amount)}</td>
                        <td style="text-align:right;"><button class="btn-small" onclick="deleteTransaction(${t.id})"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            }
        }

        function renderDebts() {
            const container = document.getElementById('debtsContainer');
            const empty = document.getElementById('debtsEmpty');
            container.innerHTML = '';
            if (data.debts.length === 0) { empty.style.display = 'block'; } 
            else { empty.style.display = 'none'; const today = new Date();
                data.debts.forEach(d => {
                    const dDate = new Date(d.date);
                    const diff = Math.ceil(Math.abs(today - dDate) / (1000 * 60 * 60 * 24));
                    const isOverdue = diff > 10 && d.status === 'pending';
                    const label = d.type === 'owed' ? 'Me deben' : 'Yo debo';
                    
                    const card = `<div class="debt-card ${d.type} ${d.status} ${isOverdue ? 'overdue' : ''}">
                        ${isOverdue ? '<span class="overdue-badge">¬°VENCIDO!</span>' : ''}
                        <div class="debt-info"><h4>${d.person}</h4><p>${label} ‚Ä¢ ${dDate.toLocaleDateString('es-CL', {timeZone:'UTC'})}</p><div class="debt-amount">${formatCurrency(d.amount)}</div></div>
                        <div class="debt-actions">
                            <button class="btn-check" onclick="toggleDebtStatus(${d.id})">${d.status==='paid'?'<i class="fas fa-undo"></i>':'<i class="fas fa-check"></i>'}</button>
                            <button class="btn-small" onclick="deleteDebt(${d.id})"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
                    container.innerHTML += card;
                });
            }
        }

        function renderShopping() {
            const container = document.getElementById('shoppingContainer');
            const empty = document.getElementById('shoppingEmpty');
            container.innerHTML = '';
            if (data.shopping.length === 0) { empty.style.display = 'block'; }
            else { empty.style.display = 'none';
                data.shopping.forEach(i => {
                    const div = `<div class="shopping-item ${i.checked ? 'checked' : ''}">
                        <div onclick="toggleShopItem(${i.id})" style="flex:1; display:flex; align-items:center; gap:10px;">
                            <i class="fas ${i.checked ? 'fa-check-square' : 'fa-square'}" style="color:var(--primary);"></i><span>${i.name}</span>
                        </div>
                        <div class="shop-actions">
                            <button class="btn-buy" onclick="buyShopItem(${i.id})">Comprar</button>
                            <button class="btn-small" onclick="deleteShopItem(${i.id})"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
                    container.innerHTML += div;
                });
            }
        }

        function renderGoals() {
            const container = document.getElementById('goalsContainer');
            const empty = document.getElementById('goalsEmpty');
            container.innerHTML = '';
            if (data.goals.length === 0) { empty.style.display = 'block'; }
            else { empty.style.display = 'none';
                data.goals.forEach(g => {
                    const percent = Math.min((g.savedAmount / g.targetAmount) * 100, 100);
                    const card = `<div class="goal-card ${percent >= 100 ? 'completed' : ''}">
                        <div class="goal-header"><div class="goal-name">${g.name}</div><div class="goal-status">${percent.toFixed(0)}%</div></div>
                        <div class="progress-bar"><div class="progress-fill" style="width:${percent}%"></div></div>
                        <div class="goal-amounts"><div class="goal-amount"><div>Ahorrado</div><div>${formatCurrency(g.savedAmount)}</div></div><div class="goal-amount"><div>Meta</div><div>${formatCurrency(g.targetAmount)}</div></div></div>
                        <div class="goal-buttons"><button onclick="addToGoal('${g.id}')">Ahorrar</button><button class="danger btn-small" onclick="deleteGoal('${g.id}')"><i class="fas fa-trash"></i></button></div>
                    </div>`;
                    container.innerHTML += card;
                });
            }
        }

        function renderGoalsProgress() {
            const container = document.getElementById('goalsProgress');
            const empty = document.getElementById('goalsProgressEmpty');
            container.innerHTML = '';
            if (data.goals.length === 0) { empty.style.display = 'block'; }
            else { empty.style.display = 'none';
                data.goals.forEach(g => {
                    const percent = Math.min((g.savedAmount / g.targetAmount) * 100, 100);
                    if(percent < 100) {
                        container.innerHTML += `<div style="margin-bottom:10px; background:white; padding:10px; border-radius:10px;"><div style="display:flex; justify-content:space-between; font-size:0.9em; font-weight:700; margin-bottom:5px;"><span>${g.name}</span><span>${percent.toFixed(0)}%</span></div><div class="progress-bar" style="height:6px; margin:0;"><div class="progress-fill" style="width:${percent}%"></div></div></div>`;
                    }
                });
            }
        }

        // --- ANIMATIONS & EXTRAS ---
        function showBearFeedback(type) {
            const overlay = document.getElementById('bearOverlay');
            const img = document.getElementById('bearAnimImg');
            const backup = document.getElementById('bearEmojiBackup');
            overlay.classList.add('show');
            if (type === 'happy') { img.src = './happy.gif'; backup.textContent = 'üêªüéâ'; }
            else { img.src = './sad.gif'; backup.textContent = 'üêªüíß'; }
            img.onload = () => { img.style.display = 'block'; backup.style.display = 'none'; };
            img.onerror = () => { img.style.display = 'none'; backup.style.display = 'block'; };
            setTimeout(() => { overlay.classList.remove('show'); setTimeout(() => { img.style.display='none'; backup.style.display='none'; }, 300); }, 2500);
        }

        function createConfetti() { const colors = ['#7BA8A8','#9BC997','#F5D5A8','#FF9F9F']; for(let i=0;i<60;i++){ const c = document.createElement('div'); c.className = 'confetti'; c.textContent = '‚òÖ'; c.style.left = Math.random()*window.innerWidth+'px'; c.style.top = '-20px'; c.style.color = colors[Math.floor(Math.random()*colors.length)]; document.body.appendChild(c); setTimeout(()=>c.remove(),3000); } }
        function showCelebration(msg) { createConfetti(); const div = document.createElement('div'); div.className = 'celebration-overlay'; div.innerHTML = `<div class="celebration-message">${msg}</div>`; document.body.appendChild(div); setTimeout(()=>div.remove(),3000); }

        initApp();
    </script>
</body>
</html>
